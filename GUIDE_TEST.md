# üß™ Guide Complet de Test de l'API de Gestion de Commandes

## ‚ö†Ô∏è Exigences Obligatoires du Projet

### üéØ Session 1 - Exigences Minimales
- ‚úÖ **Base de donn√©es** : SQLite ‚Üí **Migr√© vers PostgreSQL v12**
- ‚úÖ **Format commande** : `{"product": {"id": 1, "quantity": 2}}` 
- ‚úÖ **Paiement** : Synchrone ‚Üí **Migr√© vers asynchrone (Session 2)**
- ‚úÖ **Calculs** : Taxes selon province + frais livraison selon poids

### üéØ Session 2 - Exigences Compl√®tes (TOUTES OBLIGATOIRES)
- ‚úÖ **Multi-produits** : `{"products": [{"id": 1, "quantity": 2}, {"id": 3, "quantity": 1}]}`
- ‚úÖ **PostgreSQL v12** : Variables d'environnement (DB_HOST, DB_USER, etc.)
- ‚úÖ **Redis** : Cache + gestion t√¢ches asynchrones
- ‚úÖ **Worker RQ** : Paiements trait√©s en arri√®re-plan
- ‚úÖ **Docker Compose** : Tous services containeris√©s
- ‚úÖ **Statuts HTTP** : 202 (en cours), 409 (d√©j√† pay√©), 422 (erreur)
- ‚úÖ **Initialisation** : `flask init-db` + import produits

### üö® Contraintes Techniques Obligatoires
1. **Port 5002** : API doit √™tre accessible sur localhost:5002
2. **4 Services Docker** : api, db (PostgreSQL), redis, worker
3. **Worker actif** : `docker-compose exec api rq worker default`
4. **Base initialis√©e** : `docker-compose exec api flask init-db`
5. **Aucune erreur** dans les logs des services

## üöÄ D√©marrage Rapide

### 1. Lancer l'application
```bash
# ‚ö†Ô∏è IMPORTANT: Exigences du projet
# 1. Arr√™ter et nettoyer les anciens containers/volumes
docker-compose down -v

# 2. Construire et d√©marrer TOUS les services (obligatoire)
docker-compose up -d --build

# 3. OBLIGATOIRE: Initialiser la base de donn√©es
docker-compose exec api flask init-db

# 4. OBLIGATOIRE: D√©marrer le worker RQ (session 2)
# Dans un terminal s√©par√©:
docker-compose exec api rq worker default

# 5. Attendre que tous les services soient pr√™ts
sleep 30

# 6. Ouvrir l'interface de test
open http://localhost:5002/test
```

### ‚ö†Ô∏è Exigences Critiques du Projet
- **PostgreSQL v12** : Base de donn√©es obligatoire (pas SQLite)
- **Redis** : Cache et gestion des t√¢ches asynchrones
- **Worker RQ** : Traitement des paiements en arri√®re-plan
- **Initialisation BD** : `flask init-db` OBLIGATOIRE avant tests
- **Port 5002** : API accessible sur localhost:5002 (pas 5000)
- **Docker Compose** : Tous les services doivent √™tre op√©rationnels

### 2. Validation automatique
```bash
# üéØ NOUVEAU: V√©rification compl√®te des exigences
./check_requirements.sh

# ‚ö†Ô∏è IMPORTANT: V√©rifier que TOUS les services sont op√©rationnels
docker-compose ps

# Tous les services doivent √™tre "Up":
# - db (PostgreSQL)
# - api (Flask) 
# - redis (Cache)
# - worker (RQ)

# Script de validation complet
./validate.sh

# Tests API automatiques
./test_api.sh
```

### üîß V√©rifications Obligatoires Avant Tests
```bash
# 1. V√©rifier les containers
docker-compose ps

# 2. V√©rifier les logs (pas d'erreurs)
docker-compose logs api
docker-compose logs worker
docker-compose logs db

# 3. Tester la connectivit√© PostgreSQL
docker-compose exec db psql -U user -d api8inf349 -c "SELECT version();"

# 4. Tester Redis
docker-compose exec redis redis-cli ping

# 5. V√©rifier que les produits sont import√©s
curl -s http://localhost:5002/api/products | head -5
```

## üñ•Ô∏è Tests via Interface Web

### √âtape 1: V√©rifier l'acc√®s
- **URL**: http://localhost:5002/test
- **V√©rification**: La page doit s'afficher avec les sections de test

### √âtape 2: Tester les produits
1. Cliquer sur **"Afficher produits"**
2. **R√©sultat attendu**: JSON avec 10 produits
3. **V√©rifier**: Chaque produit a `id`, `name`, `price`, `weight`, `in_stock`
4. **Exemples de poids r√©els**:
   - Produit 1 (Brown eggs): 400g
   - Produit 2 (Sweet fresh strawberry): 299g
   - Produit 3 (Butter): 227g
   - Produit 4 (Honey): 340g

### √âtape 3: Test Session 1 (Produit unique)
1. **Cr√©er une commande**:
   - ID produit: `1`
   - Quantit√©: `2`
   - Cliquer "Cr√©er"
   - **Attendu**: "Commande cr√©√©e #1"

2. **Consulter la commande**:
   - ID commande: `1`
   - Cliquer "Afficher"
   - **Attendu**: D√©tails avec prix, poids, frais livraison

3. **Ajouter une adresse**:
   - ID commande: `1`
   - Email: `test@example.com`
   - Province: `QC - Qu√©bec (15% taxes)`
   - Adresse: `123 Rue Test`
   - Ville: `Saguenay`
   - Code postal: `G7H 5K1`
   - Cliquer "Mettre √† jour"
   - **Attendu**: Message avec recalcul des taxes

4. **Payer la commande**:
   - ID commande: `1`
   - Nom: `John Doe`
   - Num√©ro: `4242 4242 4242 4242`
   - Expiration: `12/2025`
   - CVV: `123`
   - Cliquer "Payer"
   - **Attendu**: "Paiement en cours..." (202)

5. **V√©rifier le paiement**:
   - Attendre 10 secondes
   - Consulter √† nouveau la commande #1
   - **Attendu**: "Pay√©e : Oui"

### √âtape 4: Test Session 2 (Multi-produits)
1. **Cr√©er commande multi-produits**:
   - Produit 1: ID `2`, Quantit√© `1`
   - Cliquer "+ Ajouter un produit"
   - Produit 2: ID `3`, Quantit√© `2`
   - Cliquer "Cr√©er"
   - **Attendu**: Commande avec 2 produits

2. **Tester calculs complexes**:
   - Ajouter adresse Ontario (`ON`)
   - **Attendu**: Taxes 13% + frais livraison selon poids total

### √âtape 5: Tests Sp√©cifiques aux Poids
1. **Test poids l√©ger (‚â§500g)**:
   - Cr√©er commande: Produit 2 (Strawberry 299g) √ó 1
   - **Attendu**: Frais livraison 5,00$ CAD

2. **Test poids moyen (501-2000g)**:
   - Cr√©er commande: Produit 1 (Brown eggs 400g) √ó 2 = 800g
   - **Attendu**: Frais livraison 10,00$ CAD

3. **Test poids lourd (>2000g)**:
   - Cr√©er commande: Produit 1 (Brown eggs 400g) √ó 6 = 2400g
   - **Attendu**: Frais livraison 25,00$ CAD

4. **Test multi-produits avec calcul poids**:
   - Produit 1 (400g) √ó 2 + Produit 2 (299g) √ó 1 = 1099g
   - **Attendu**: Frais livraison 10,00$ CAD (tranche 501-2000g)

### √âtape 6: Tests d'erreur
1. **Produit inexistant**: ID `999` ‚Üí "Produit 999 introuvable"
2. **Quantit√© invalide**: `0` ‚Üí "Quantit√© invalide"
3. **Carte invalide**: `1234` ‚Üí "Num√©ro de carte invalide"
4. **Double paiement**: Payer une commande pay√©e ‚Üí "D√©j√† pay√©e!"

## üîß Tests API Directs (curl)

### Configuration
```bash
export API_URL="http://localhost:5002"
```

### Tests de base
```bash
# 1. Lister les produits (voir les poids)
curl -X GET $API_URL/api/products

# 2. Cr√©er commande Session 1
curl -X POST $API_URL/order \
  -H "Content-Type: application/json" \
  -d '{"product": {"id": 1, "quantity": 2}}'

# 3. Cr√©er commande Session 2
curl -X POST $API_URL/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 1, "quantity": 2}, {"id": 3, "quantity": 1}]}'

# 4. Test poids l√©ger (‚â§500g) - Strawberry 299g √ó 1
curl -X POST $API_URL/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 2, "quantity": 1}]}'

# 5. Test poids moyen (501-2000g) - Brown eggs 400g √ó 2 = 800g
curl -X POST $API_URL/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 1, "quantity": 2}]}'

# 6. Test poids lourd (>2000g) - Brown eggs 400g √ó 6 = 2400g
curl -X POST $API_URL/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 1, "quantity": 6}]}'

# 7. Consulter commande (voir calculs de poids)
curl -X GET $API_URL/order/1

# 5. Mettre √† jour adresse
curl -X PUT $API_URL/order/1 \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "shipping_information": {
      "province": "QC",
      "address": "123 Rue Test",
      "city": "Saguenay",
      "postal_code": "G7H 5K1"
    }
  }'

# 6. Payer
curl -X PUT $API_URL/order/1 \
  -H "Content-Type: application/json" \
  -d '{
    "credit_card": {
      "name": "John Doe",
      "number": "4242424242424242",
      "expiration_month": 12,
      "expiration_year": 2025,
      "cvv": "123"
    }
  }'
```

## üìä R√©sultats Attendus

### Calculs de Taxes
- **QC (Qu√©bec)**: 15% sur prix produits
- **ON (Ontario)**: 13% sur prix produits  
- **AB (Alberta)**: 5% sur prix produits
- **Autres**: 0% (non configur√©)

### Frais de Livraison
- **‚â§ 500g**: 5,00 CAD
- **501-2000g**: 10,00 CAD
- **> 2000g**: 25,00 CAD

**Formule**: `total_weight = Œ£(product.weight √ó quantity)`

### Exemple Complet
```
Produit 1 (Brown eggs): 28,10$ √ó 2 = 56,20$ (400g √ó 2 = 800g)
Frais livraison: 800g ‚Üí 10,00$ (dans tranche 501-2000g)
Taxes QC (15%): 56,20$ √ó 1.15 = 64,63$ TTC
TOTAL FINAL: 64,63$ + 10,00$ = 74,63$ CAD
```

### Exemples avec Diff√©rents Poids
```
ü•ö Produit 1 (Brown eggs - 400g):
   √ó 1 = 400g ‚Üí Livraison 5,00$ (‚â§500g)
   √ó 2 = 800g ‚Üí Livraison 10,00$ (501-2000g)
   √ó 6 = 2400g ‚Üí Livraison 25,00$ (>2000g)

üçì Produit 2 (Strawberry - 299g):
   √ó 1 = 299g ‚Üí Livraison 5,00$ (‚â§500g)
   √ó 2 = 598g ‚Üí Livraison 10,00$ (501-2000g)
   √ó 7 = 2093g ‚Üí Livraison 25,00$ (>2000g)

üßà Multi-produits:
   2√ó Brown eggs (800g) + 1√ó Strawberry (299g) = 1099g
   ‚Üí Livraison 10,00$ (501-2000g)
```

### Codes de Retour
- **200**: Succ√®s
- **302**: Redirection apr√®s cr√©ation
- **202**: Paiement en cours (asynchrone)
- **409**: Commande d√©j√† pay√©e
- **422**: Erreur de validation
- **404**: Commande introuvable

## üêõ Diagnostic

### ‚ùå Erreurs Courantes et Solutions

#### **"Connection refused" ou API inaccessible**
```bash
# V√©rifier que TOUS les services sont "Up"
docker-compose ps

# Si des services sont "Exit" ou manquants:
docker-compose down -v
docker-compose up -d --build
```

#### **"Base de donn√©es vide" ou "Table doesn't exist"**
```bash
# OBLIGATOIRE apr√®s chaque red√©marrage
docker-compose exec api flask init-db

# V√©rifier que les tables existent
docker-compose exec db psql -U user -d api8inf349 -c "\dt"
```

#### **Paiements qui ne se traitent jamais (restent en 202)**
```bash
# Le worker RQ DOIT √™tre d√©marr√© manuellement
docker-compose exec api rq worker default

# Dans un terminal s√©par√©, laisser tourner en permanence
```

#### **"Redis connection failed"**
```bash
# V√©rifier Redis
docker-compose exec redis redis-cli ping
# Doit retourner "PONG"

# Si √©chec, red√©marrer Redis
docker-compose restart redis
```

### Services qui ne d√©marrent pas
```bash
# V√©rifier l'√©tat des conteneurs
docker-compose ps

# Voir les logs
docker-compose logs api
docker-compose logs worker
docker-compose logs db
docker-compose logs redis

# Red√©marrer un service
docker-compose restart api
```

### Base de donn√©es vide
```bash
# R√©initialiser
docker-compose exec api flask init-db

# V√©rifier les tables
docker-compose exec db psql -U user -d api8inf349 -c "\dt"
```

### Probl√®mes de paiement
```bash
# V√©rifier le worker Redis
docker-compose logs worker

# V√©rifier Redis
docker-compose exec redis redis-cli ping

# Red√©marrer le worker
docker-compose restart worker
```

### Port occup√©
```bash
# Trouver ce qui utilise le port 5002
lsof -ti:5002

# Tuer le processus
lsof -ti:5002 | xargs kill

# Ou changer le port dans docker-compose.yml
```

## üéØ Checklist de Validation

### ‚úÖ Fonctionnalit√©s Core
- [ ] API accessible (GET /api/products)
- [ ] Cr√©ation commande produit unique (Session 1)
- [ ] Cr√©ation commande multi-produits (Session 2)
- [ ] Consultation commande (GET /order/id)
- [ ] Mise √† jour adresse + calcul taxes
- [ ] Paiement asynchrone (statut 202)
- [ ] V√©rification paiement trait√©

### ‚úÖ Calculs M√©tier
- [ ] Frais livraison selon poids total (Œ£(weight √ó quantity))
- [ ] Poids calcul√© correctement pour multi-produits
- [ ] Seuils de poids respect√©s (500g, 2000g)
- [ ] Taxes selon province (QC 15%, ON 13%, AB 5%)
- [ ] Taxes appliqu√©es aux produits uniquement
- [ ] Recalcul automatique lors mise √† jour

### ‚úÖ Gestion d'Erreurs
- [ ] Produit inexistant (422)
- [ ] Quantit√© invalide (422)
- [ ] Carte de cr√©dit invalide (422)
- [ ] Double paiement (409)
- [ ] Commande introuvable (404)

### ‚úÖ Interface Web
- [ ] Formulaires fonctionnels
- [ ] Validation c√¥t√© client
- [ ] Messages d'erreur clairs
- [ ] Affichage d√©taill√© des calculs

### ‚úÖ Architecture
- [ ] Docker containers op√©rationnels (docker-compose ps)
- [ ] PostgreSQL v12 connect√© et initialis√©
- [ ] Redis op√©rationnel (redis-cli ping)
- [ ] Worker RQ d√©marr√© et en attente
- [ ] Flask init-db ex√©cut√© avec succ√®s
- [ ] Produits import√©s depuis l'API externe
- [ ] Cache Redis pour commandes pay√©es
- [ ] Port 5002 accessible (pas de conflit)
- [ ] Variables d'environnement correctes
- [ ] Volumes Docker persistants

## üèÜ Tests de Performance

### Tests de Poids et Calculs
```bash
# Test avec diff√©rents poids pour v√©rifier les calculs
echo "üß™ Test calculs de poids et frais de livraison"

# Poids l√©ger (‚â§500g)
echo "Test 1: Poids l√©ger"
curl -X POST http://localhost:5002/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 2, "quantity": 1}]}' # Strawberry 299g

# Poids moyen (501-2000g)  
echo "Test 2: Poids moyen"
curl -X POST http://localhost:5002/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 1, "quantity": 2}]}' # Brown eggs 800g

# Poids lourd (>2000g)
echo "Test 3: Poids lourd"
curl -X POST http://localhost:5002/order \
  -H "Content-Type: application/json" \
  -d '{"products": [{"id": 1, "quantity": 6}]}' # Brown eggs 2400g
```

### Charge
```bash
# Test de charge avec Apache Bench
ab -n 100 -c 10 http://localhost:5002/api/products

# Test de cr√©ation de commandes
for i in {1..10}; do
  curl -X POST http://localhost:5002/order \
    -H "Content-Type: application/json" \
    -d '{"products": [{"id": 1, "quantity": 2}]}'
done
```

### Monitoring
```bash
# Utilisation CPU/RAM
docker stats

# Logs en temps r√©el
docker-compose logs -f api worker
```

## üìö Ressources

- **Documentation**: `README.md` et `QUICK_START.md`
- **Scripts**: `start.sh`, `stop.sh`, `validate.sh`, `test_api.sh`
- **Interface**: http://localhost:5002/test
- **Logs**: `docker-compose logs`
