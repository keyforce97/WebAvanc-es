<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes ‚Äì Test API</title>
  <style>
    /* Reset & typo */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: "Segoe UI", sans-serif; background: #f0f4f8; color: #333; padding: 2rem; }
    h1 { margin-bottom: 0.5rem; color: #005f99; }

    /* Card container */
    .card { background: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; }

    /* Form layout */
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; font-weight: 600; }
    input, select, textarea { padding: 0.5rem; border: 1px solid #ccc; border-radius: .5rem; font-size: 1rem; }
    .products-list { display: grid; gap: .5rem; margin-top: .5rem; }
    .product-item { display: flex; gap: .5rem; }
    .product-item input { flex: 1; }

    /* Buttons */
    .btn { padding: .75rem 1.5rem; border: none; border-radius: 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .btn-add    { background: #007acc; color: #fff; width: fit-content; }
    .btn-submit { background: #28a745; color: #fff; }
    .btn-blue   { background: #007bff; color: white; }
    .btn-yellow { background: #ffc107; color: #333; }

    /* Inline small form */
    .inline { display: flex; gap: .5rem; align-items: center; }
    .inline input { width: 4rem; }

    /* Output JSON */
    pre#productsOutput {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: .5rem;
      max-height: 300px;
      overflow: auto;
      margin-top: 1rem;
      font-family: monospace;
      font-size: .9rem;
    }

    /* Rules section */
    .rules { background: #e8f4fd; border-left: 4px solid #007acc; padding: 1rem; margin: 1rem 0; }
    .rules h3 { color: #005f99; margin-bottom: 0.5rem; }
    .rules ul { margin-left: 1rem; }
    .rules li { margin: 0.25rem 0; }
    .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
    .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
  </style>
</head>
<body>

  <!-- Liste des produits (maintenant en haut) -->
  <div class="card">
    <h1>üì¶ Liste des produits</h1>
    <div class="inline">
      <button id="listProductsBtn" class="btn btn-blue">Afficher produits</button>
      <button id="testSequenceBtn" class="btn btn-yellow">üß™ Test automatique</button>
    </div>
    <pre id="productsOutput"></pre>
  </div>

  <!-- Cr√©er une commande -->
  <div class="card">
    <h1>Cr√©er une commande</h1>
    <div class="rules info">
      <h4>üìù Instructions :</h4>
      <ul>
        <li><strong>Session 1 :</strong> Utilisez 1 seul produit (les autres seront ignor√©s par le backend)</li>
        <li><strong>Session 2 :</strong> Vous pouvez ajouter plusieurs produits avec le bouton "+Ajouter"</li>
        <li><strong>Calculs automatiques :</strong> Frais de livraison selon poids total d√®s la cr√©ation</li>
        <li><strong>Taxes :</strong> Calcul√©es seulement apr√®s ajout d'une adresse avec province</li>
      </ul>
    </div>
    <form id="orderForm">
      <div class="products-list" id="productsList">
        <div class="product-item">
          <input type="number" name="product_id" placeholder="ID produit" min="1" required>
          <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
        </div>
      </div>
      <button type="button" class="btn btn-add"    id="addProduct">+ Ajouter un produit</button>
      <button type="submit" class="btn btn-submit">Cr√©er</button>
    </form>
  </div>

  <!-- Afficher une commande -->
  <div class="card">
    <h1>Afficher une commande</h1>
    <form id="getOrderForm" class="inline">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <button type="submit" class="btn btn-blue">Afficher</button>
    </form>
  </div>

  <!-- Ajouter une adresse -->
  <div class="card">
    <h1>Ajouter une adresse (taxes)</h1>
    <div class="rules warning">
      <h4>‚ö†Ô∏è Rappel :</h4>
      <ul>
        <li><strong>Taxes par province :</strong> QC=15%, ON=13%, AB=5%, BC=12%, NS=14%, autres=0%</li>
        <li><strong>Important :</strong> Les taxes s'appliquent seulement sur le prix des produits, pas sur les frais de livraison</li>
      </ul>
    </div>
    <form id="shippingForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Adresse :
        <input type="text" name="address" placeholder="123 rue de la Paix" required>
      </label>
      <label>Ville :
        <input type="text" name="city" placeholder="Montr√©al" required>
      </label>
      <label>Province :
        <select name="province" required>
          <option value="">S√©lectionnez‚Ä¶</option>
          <option value="QC">QC - Qu√©bec (15%)</option>
          <option value="ON">ON - Ontario (13%)</option>
          <option value="AB">AB - Alberta (5%)</option>
          <option value="BC">BC - Colombie-Britannique (12%)</option>
          <option value="NS">NS - Nouvelle-√âcosse (14%)</option>
          <option value="NB">NB - Nouveau-Brunswick (0%)</option>
          <option value="PE">PE - √éle-du-Prince-√âdouard (0%)</option>
          <option value="SK">SK - Saskatchewan (0%)</option>
          <option value="MB">MB - Manitoba (0%)</option>
          <option value="NL">NL - Terre-Neuve-et-Labrador (0%)</option>
          <option value="NT">NT - Territoires du Nord-Ouest (0%)</option>
          <option value="NU">NU - Nunavut (0%)</option>
          <option value="YT">YT - Yukon (0%)</option>
        </select>
      </label>
      <label>Code postal :
        <input type="text" name="postal_code" placeholder="H2X 3Y4" required>
      </label>
      <label>Pays :
        <input type="text" name="country" value="Canada" required>
      </label>
      <button type="submit" class="btn btn-submit">Ajouter adresse</button>
    </form>
  </div>

  <!-- Payer une commande -->
  <div class="card">
    <h1>Payer une commande</h1>
    <div class="rules warning">
      <h4>üí≥ Cartes de test :</h4>
      <ul>
        <li><strong>Succ√®s :</strong> 4242 4242 4242 4242</li>
        <li><strong>D√©clin√©e :</strong> 4000 0000 0000 0002</li>
        <li><strong>Expiry/CVC :</strong> Utilisez des valeurs futures valides (ex: 12/25, 123)</li>
      </ul>
    </div>
    <form id="paymentForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Num√©ro de carte :
        <input type="text" name="credit_card_number" placeholder="4242 4242 4242 4242" required>
      </label>
      <label>Date d'expiration :
        <input type="text" name="credit_card_expiry_date" placeholder="12/25" required>
      </label>
      <label>CVC :
        <input type="text" name="credit_card_cvv" placeholder="123" required>
      </label>
      <button type="submit" class="btn btn-submit">Payer</button>
    </form>
  </div>

  <!-- Afficher le JSON brut -->
  <div class="card">
    <h1>üîç R√©sultat JSON</h1>
    <pre id="output"></pre>
  </div>

  <!-- Calculateur de taxes et frais -->
  <div class="card">
    <h1>üßÆ Calculateur de Taxes et Frais</h1>
    <div class="rules info">
      <h4>üìä Outil de v√©rification des calculs :</h4>
      <p>Utilisez cet outil pour v√©rifier manuellement les calculs de taxes et frais de livraison selon les r√®gles m√©tier.</p>
    </div>
    <form id="calculatorForm" class="inline">
      <label>Prix ($) :
        <input type="number" name="price" step="0.01" placeholder="Ex: 29.99" required>
      </label>
      <label>Quantit√© :
        <input type="number" name="quantity" min="1" placeholder="Ex: 2" required>
      </label>
      <label>Poids (g) :
        <input type="number" name="weight" min="1" placeholder="Ex: 300" required>
      </label>
      <label>Province :
        <select name="province_calc">
          <option value="0">Aucune (0%)</option>
          <option value="5">AB - Alberta (5%)</option>
          <option value="12">BC - Colombie-Britannique (12%)</option>
          <option value="13">ON - Ontario (13%)</option>
          <option value="14">NS - Nouvelle-√âcosse (14%)</option>
          <option value="15">QC - Qu√©bec (15%)</option>
        </select>
      </label>
      <button type="submit" class="btn btn-blue">Calculer</button>
    </form>
    <pre id="calculatorOutput"></pre>
  </div>

  <script>
    // URL de base de l'API
    const API_BASE = window.location.origin;

    // Fonction utilitaire pour afficher le JSON
    const displayOutput = (data) => {
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    };

    // 1) Lister les produits
    document.getElementById('listProductsBtn').onclick = async () => {
      try {
        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();
        document.getElementById('productsOutput').textContent = JSON.stringify(data, null, 2);
        displayOutput(data);
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // 2) Fonction utilitaire pour calculer les frais de livraison
    const calculateShippingPrice = (weightInGrams) => {
      if (weightInGrams <= 500) return 500;       // 5.00 CAD
      if (weightInGrams <= 2000) return 1000;     // 10.00 CAD
      return 2500;                                // 25.00 CAD
    };

    // 3) Fonction utilitaire pour calculer les taxes
    const calculateTaxes = (price, province) => {
      const taxRates = {
        'QC': 0.15, 'ON': 0.13, 'AB': 0.05, 'BC': 0.12, 'NS': 0.14
      };
      const rate = taxRates[province] || 0;
      return Math.round(price * (1 + rate));
    };

    // 4) Ajouter un produit dans le formulaire
    document.getElementById('addProduct').onclick = () => {
      const productsList = document.getElementById('productsList');
      const newItem = document.createElement('div');
      newItem.className = 'product-item';
      newItem.innerHTML = `
        <input type="number" name="product_id" placeholder="ID produit" min="1" required>
        <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
        <button type="button" class="btn" style="background: #dc3545; color: white; padding: 0.5rem;" onclick="this.parentElement.remove()">√ó</button>
      `;
      productsList.appendChild(newItem);
    };

    // 5) Cr√©er une commande
    document.getElementById('orderForm').onsubmit = async (e) => {
      e.preventDefault();
      
      // R√©cup√©rer la liste des produits pour enrichir les infos
      let allProducts = [];
      try {
        const res = await fetch(`${API_BASE}/products`);
        allProducts = await res.json();
      } catch (error) {
        console.warn('Impossible de r√©cup√©rer la liste des produits:', error);
      }

      const formData = new FormData(e.target);
      const productIds = formData.getAll('product_id');
      const quantities = formData.getAll('quantity');

      const products = productIds.map((id, index) => ({
        id: parseInt(id),
        quantity: parseInt(quantities[index])
      })).filter(p => p.id && p.quantity > 0);

      if (products.length === 0) {
        alert('‚ùå Veuillez ajouter au moins un produit.');
        return;
      }

      // Calcul estimatif c√¥t√© frontend
      let estimatedPrice = 0;
      let estimatedWeight = 0;
      let productDetails = [];

      products.forEach(product => {
        const productInfo = allProducts.find(p => p.id === product.id);
        if (productInfo) {
          const itemPrice = productInfo.price * product.quantity;
          const itemWeight = productInfo.weight * product.quantity;
          estimatedPrice += itemPrice;
          estimatedWeight += itemWeight;
          productDetails.push({
            ...productInfo,
            quantity: product.quantity,
            totalPrice: itemPrice,
            totalWeight: itemWeight
          });
        }
      });

      const estimatedShipping = calculateShippingPrice(estimatedWeight);

      console.log('üí° Estimation c√¥t√© frontend:');
      console.log(`‚Ä¢ Prix total: ${estimatedPrice / 100}$`);
      console.log(`‚Ä¢ Poids total: ${estimatedWeight}g`);
      console.log(`‚Ä¢ Frais livraison: ${estimatedShipping / 100}$`);
      console.log('‚Ä¢ D√©tails:', productDetails);

      const payload = { products };

      try {
        const res = await fetch(`${API_BASE}/order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          redirect: 'manual'
        });

        if (res.status === 0 || res.status === 302) {
          // Redirection 302 d√©tect√©e ‚Üí succ√®s
          const orderId = extractOrderIdFromRedirect(res);
          alert(`‚úÖ Commande cr√©√©e ! ID: ${orderId || 'Inconnue'}\n\nüí° Estimation: ${estimatedPrice / 100}$ + livraison ${estimatedShipping / 100}$ = ${(estimatedPrice + estimatedShipping) / 100}$`);
          // R√©cup√©rer automatiquement la commande cr√©√©e
          if (orderId) {
            setTimeout(() => getOrder(orderId), 500);
          }
        } else {
          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { message: text };
          }
          displayOutput(data);
          alert(`‚ùå Erreur ${res.status}: ${data.message || text}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // Fonction utilitaire pour extraire l'ID de commande depuis la redirection
    const extractOrderIdFromRedirect = (response) => {
      try {
        const location = response.headers.get('location') || response.url;
        const match = location.match(/\/order\/(\d+)/);
        return match ? parseInt(match[1]) : null;
      } catch {
        return null;
      }
    };

    // 6) Afficher la liste des produits
    document.getElementById('listProductsBtn').onclick = async () => {
      try {
        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();
        document.getElementById('productsOutput').textContent = JSON.stringify(data, null, 2);
        displayOutput(data);
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // 7) Afficher une commande
    const getOrder = async (orderId) => {
      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`);
        const data = await res.json();
        displayOutput(data);
        
        if (res.ok) {
          const order = data.order || data;
          
          // D√©terminer le statut avec ic√¥nes plus claires
          let status = '‚ùå Non pay√©e';
          let statusColor = 'üî¥';
          if (order.order_status === 'paid') {
            status = '‚úÖ PAY√âE';
            statusColor = 'üü¢';
          } else if (order.order_status === 'payment_processing') {
            status = '‚è≥ Paiement en cours...';
            statusColor = 'üü°';
          }
          
          // Affichage d√©taill√© avec statut de paiement en √©vidence
          let message = `üìä COMMANDE ${orderId}\n`;
          message += `${statusColor} STATUT: ${status}\n`;
          message += `\nüí∞ D√âTAILS FINANCIERS:\n`;
          message += `   ‚Ä¢ Sous-total: ${order.total_price}$\n`;
          message += `   ‚Ä¢ Livraison: ${order.shipping_price / 100}$\n`;
          
          if (order.shipping_information && order.shipping_information.province) {
            const province = order.shipping_information.province;
            const taxRates = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' };
            const taxRate = taxRates[province] || '0%';
            message += `   ‚Ä¢ Province: ${province} (Taxe ${taxRate})\n`;
          }
          
          if (order.total_price_tax && order.total_price_tax > 0) {
            message += `   ‚Ä¢ Total avec taxes: ${order.total_price_tax}$\n`;
            message += `\nüéØ TOTAL FINAL: ${(order.total_price_tax + order.shipping_price / 100).toFixed(2)}$ CAD`;
          } else {
            message += `\nüßæ Taxes: Non calcul√©es (ajoutez une adresse)`;
          }
          
          // Ajouter info transaction si pay√©e
          if (order.paid && order.transaction && order.transaction.id) {
            message += `\n\nüí≥ Transaction: ${order.transaction.id}`;
          }
          
          alert(message);
        } else if (res.status === 202) {
          alert('‚è≥ Commande en cours de traitement (paiement asynchrone)');
        } else {
          alert(`‚ùå Erreur ${res.status}: ${data.message}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    document.getElementById('getOrderForm').onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      await getOrder(orderId);
    };

    // 8) Ajouter une adresse
    document.getElementById('shippingForm').onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      
      const payload = {
        shipping_information: {
          address: formData.get('address'),
          city: formData.get('city'),
          province: formData.get('province'),
          postal_code: formData.get('postal_code'),
          country: formData.get('country')
        }
      };

      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { message: text };
        }

        displayOutput(data);

        if (res.ok) {
          const province = formData.get('province');
          const taxRate = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' }[province] || '0%';
          alert(`‚úÖ Adresse ajout√©e !\nüè† Province: ${province} (Taxe ${taxRate})\nüí° Les taxes ont √©t√© recalcul√©es automatiquement.`);
          
          // Afficher automatiquement la commande mise √† jour
          setTimeout(() => getOrder(orderId), 500);
        } else {
          if (res.status === 409) {
            alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
          } else {
            const err = data.errors?.shipping_information || {};
            alert(`‚ùå Erreur adresse : ${err.province || err.address || data.message || text}`);
          }
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // 9) Payer une commande
    document.getElementById('paymentForm').onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      
      const payload = {
        credit_card: {
          credit_card_number: formData.get('credit_card_number'),
          credit_card_expiry_date: formData.get('credit_card_expiry_date'),
          credit_card_cvv: formData.get('credit_card_cvv')
        }
      };

      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { message: text };
        }

        displayOutput(data);

        if (res.ok) {
          alert('‚úÖ Paiement effectu√© avec succ√®s !');
          // Afficher la commande pay√©e
          setTimeout(() => getOrder(orderId), 500);
        } else if (res.status === 202) {
          alert('‚è≥ Paiement en cours de traitement...\nüí° Statut: 202 Accepted (traitement asynchrone)\nüîÑ Consultez la commande dans quelques secondes.');
        } else {
          if (res.status === 409) {
            alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
          } else {
            const err = data.errors?.order || {};
            alert(`‚ùå Erreur paiement : ${err.name || data.message || text}`);
          }
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // 10) Calculateur de taxes et frais
    document.getElementById('calculatorForm').onsubmit = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const price = parseFloat(formData.get('price')) * 100; // en centimes
      const quantity = parseInt(formData.get('quantity'));
      const weight = parseInt(formData.get('weight'));
      const taxRate = parseInt(formData.get('province_calc'));

      const totalPrice = price * quantity;
      const totalWeight = weight * quantity;
      const shippingPrice = calculateShippingPrice(totalWeight);
      const priceWithTax = Math.round(totalPrice * (1 + taxRate / 100));
      const finalTotal = priceWithTax + shippingPrice;

      const result = {
        produit: {
          prix_unitaire: `${price / 100}$`,
          quantit√©: quantity,
          poids_unitaire: `${weight}g`,
          total_prix: `${totalPrice / 100}$`,
          total_poids: `${totalWeight}g`
        },
        frais_livraison: {
          r√®gle: totalWeight <= 500 ? '‚â§500g ‚Üí 5$' : totalWeight <= 2000 ? '501-2000g ‚Üí 10$' : '>2000g ‚Üí 25$',
          montant: `${shippingPrice / 100}$`
        },
        taxes: {
          taux: `${taxRate}%`,
          prix_avec_taxes: `${priceWithTax / 100}$`,
          note: 'Taxes appliqu√©es seulement sur le prix des produits'
        },
        total_final: `${finalTotal / 100}$ CAD`
      };

      document.getElementById('calculatorOutput').textContent = JSON.stringify(result, null, 2);
    };

    // 11) Test automatique complet
    document.getElementById('testSequenceBtn').onclick = async () => {
      const confirmTest = confirm('üß™ Lancer le test automatique complet ?\n\nüìã S√©quence:\n1. R√©cup√©rer les produits\n2. Cr√©er une commande (produit 1, qt√© 2)\n3. Consulter la commande\n4. Ajouter adresse QC\n5. Re-consulter (avec taxes)\n6. Payer avec carte test\n7. Consulter final\n\n‚è±Ô∏è Dur√©e: ~10 secondes');
      
      if (!confirmTest) return;

      const log = (msg) => {
        console.log(`üß™ TEST: ${msg}`);
        document.getElementById('output').textContent += `\nüß™ ${msg}`;
      };

      try {
        log('D√©but du test automatique...');

        // 1. R√©cup√©rer les produits
        log('1/7 R√©cup√©ration des produits...');
        const productsRes = await fetch(`${API_BASE}/products`);
        const products = await productsRes.json();
        log(`‚úì ${products.length} produits r√©cup√©r√©s`);

        // 2. Cr√©er une commande
        log('2/7 Cr√©ation commande (produit 1, qt√© 2)...');
        const createRes = await fetch(`${API_BASE}/order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products: [{ id: 1, quantity: 2 }] }),
          redirect: 'manual'
        });

        if (createRes.status !== 0 && createRes.status !== 302) {
          throw new Error(`√âchec cr√©ation commande: ${createRes.status}`);
        }

        // Extraire l'ID de commande
        let orderId = 1; // fallback
        try {
          const location = createRes.headers.get('location') || createRes.url;
          const match = location.match(/\/order\/(\d+)/);
          if (match) orderId = parseInt(match[1]);
        } catch {}

        log(`‚úì Commande cr√©√©e ID: ${orderId}`);
        await new Promise(r => setTimeout(r, 1000));

        // 3. Consulter la commande
        log('3/7 Consultation initiale...');
        const getRes1 = await fetch(`${API_BASE}/order/${orderId}`);
        const order1 = await getRes1.json();
        log(`‚úì Prix: ${order1.order?.total_price / 100 || '?'}$, Livraison: ${order1.order?.shipping_price / 100 || '?'}$`);
        await new Promise(r => setTimeout(r, 1000));

        // 4. Ajouter adresse QC
        log('4/7 Ajout adresse QC (taxes 15%)...');
        const shippingRes = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shipping_information: {
              address: '123 rue Test',
              city: 'Montreal',
              province: 'QC',
              postal_code: 'H2X 3Y4',
              country: 'Canada'
            }
          })
        });

        if (!shippingRes.ok) {
          throw new Error(`√âchec ajout adresse: ${shippingRes.status}`);
        }
        log('‚úì Adresse QC ajout√©e');
        await new Promise(r => setTimeout(r, 1000));

        // 5. Re-consulter avec taxes
        log('5/7 Consultation avec taxes...');
        const getRes2 = await fetch(`${API_BASE}/order/${orderId}`);
        const order2 = await getRes2.json();
        log(`‚úì Avec taxes QC: ${order2.order?.total_price_tax / 100 || '?'}$ + livraison ${order2.order?.shipping_price / 100 || '?'}$`);
        await new Promise(r => setTimeout(r, 1000));

        // 6. Payer
        log('6/7 Paiement carte test...');
        const payRes = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            credit_card: {
              credit_card_number: '4242424242424242',
              credit_card_expiry_date: '12/25',
              credit_card_cvv: '123'
            }
          })
        });

        if (payRes.status === 202) {
          log('‚è≥ Paiement 202: traitement asynchrone...');
          await new Promise(r => setTimeout(r, 3000)); // Attendre le worker
        } else if (!payRes.ok) {
          throw new Error(`√âchec paiement: ${payRes.status}`);
        } else {
          log('‚úì Paiement imm√©diat accept√©');
        }

        // 7. Consultation finale
        log('7/7 Consultation finale...');
        const getRes3 = await fetch(`${API_BASE}/order/${orderId}`);
        const order3 = await getRes3.json();
        const finalOrder = order3.order || order3;
        
        log(`üéâ TEST TERMIN√â !`);
        log(`üìä R√©sultat final:`);
        log(`‚Ä¢ ID: ${orderId}`);
        log(`‚Ä¢ Statut: ${finalOrder.order_status}`);
        log(`‚Ä¢ Prix avec taxes: ${finalOrder.total_price_tax}$`);
        log(`‚Ä¢ Frais livraison: ${finalOrder.shipping_price / 100}$`);
        log(`‚Ä¢ TOTAL FINAL: ${(finalOrder.total_price_tax + finalOrder.shipping_price / 100)}$ CAD`);

        displayOutput(finalOrder);
        alert(`üéâ Test automatique termin√© !\n\nüìä Commande ${orderId}:\nüí∞ ${finalOrder.total_price_tax}$ (avec taxes QC) + ${finalOrder.shipping_price / 100}$ (livraison)\nüèÜ TOTAL: ${(finalOrder.total_price_tax + finalOrder.shipping_price / 100)}$ CAD\n\n‚úÖ Statut: ${finalOrder.order_status}`);

      } catch (error) {
        log(`‚ùå √âCHEC: ${error.message}`);
        alert(`‚ùå Test automatique √©chou√©: ${error.message}`);
      }
    };
  </script>
</body>
</html>
