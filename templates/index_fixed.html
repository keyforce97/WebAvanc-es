<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes ‚Äì Test API</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; line-height: 1.6; margin: 2rem; background: #f5f7fa; }
    .card { background: white; padding: 2rem; margin: 2rem 0; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .btn { padding: 0.75rem 1.5rem; margin: 0.5rem 0.25rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
    .btn-blue { background: #3498db; color: white; }
    .btn-green { background: #27ae60; color: white; }
    .btn-submit { background: #27ae60; color: white; }
    .btn-add { background: #9b59b6; color: white; }
    .btn:hover { opacity: 0.9; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    label { display: flex; flex-direction: column; gap: 0.5rem; font-weight: 500; }
    input, select { padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; }
    input:focus, select:focus { outline: none; border-color: #3498db; }
    pre { background: #2c3e50; color: #ecf0f1; padding: 1.5rem; border-radius: 6px; overflow-x: auto; max-height: 400px; }
    .inline { flex-direction: row; align-items: end; gap: 1rem; }
    .products-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .product-item { display: flex; gap: 0.5rem; align-items: center; }
    .product-item input { flex: 1; }
  </style>
</head>
<body>
  <h1>üß™ Interface de Test ‚Äì API de Gestion de Commandes</h1>

  <!-- Liste des produits -->
  <div class="card">
    <h1>Liste des produits</h1>
    <button id="listProductsBtn" class="btn btn-blue">Afficher produits</button>
    <pre id="productsOutput"></pre>
  </div>

  <!-- Cr√©er une commande -->
  <div class="card">
    <h1>Cr√©er une commande</h1>
    <form id="orderForm">
      <div class="products-list" id="productsList">
        <div class="product-item">
          <input type="number" name="product_id" placeholder="ID produit" min="1" required>
          <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
        </div>
      </div>
      <button type="button" class="btn btn-add"    id="addProduct">+ Ajouter un produit</button>
      <button type="submit" class="btn btn-submit">Cr√©er</button>
    </form>
  </div>

  <!-- Afficher une commande -->
  <div class="card">
    <h1>Afficher une commande</h1>
    <form id="getOrderForm" class="inline">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <button type="submit" class="btn btn-blue">Afficher</button>
    </form>
  </div>

  <!-- Ajouter une adresse -->
  <div class="card">
    <h1>Ajouter une adresse de livraison</h1>
    <form id="shippingForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Adresse :
        <input type="text" name="address" placeholder="123 rue de la Paix" required>
      </label>
      <label>Ville :
        <input type="text" name="city" placeholder="Montr√©al" required>
      </label>
      <label>Province :
        <select name="province" required>
          <option value="">S√©lectionnez‚Ä¶</option>
          <option value="QC">QC - Qu√©bec (15%)</option>
          <option value="ON">ON - Ontario (13%)</option>
          <option value="AB">AB - Alberta (5%)</option>
          <option value="BC">BC - Colombie-Britannique (12%)</option>
          <option value="NS">NS - Nouvelle-√âcosse (14%)</option>
          <option value="NB">NB - Nouveau-Brunswick (0%)</option>
          <option value="PE">PE - √éle-du-Prince-√âdouard (0%)</option>
          <option value="SK">SK - Saskatchewan (0%)</option>
          <option value="MB">MB - Manitoba (0%)</option>
          <option value="NL">NL - Terre-Neuve-et-Labrador (0%)</option>
          <option value="NT">NT - Territoires du Nord-Ouest (0%)</option>
          <option value="NU">NU - Nunavut (0%)</option>
          <option value="YT">YT - Yukon (0%)</option>
        </select>
      </label>
      <label>Code postal :
        <input type="text" name="postal_code" placeholder="H2X 3Y4" required>
      </label>
      <label>Pays :
        <input type="text" name="country" value="Canada" required>
      </label>
      <button type="submit" class="btn btn-submit">Ajouter adresse</button>
    </form>
  </div>

  <!-- Payer une commande -->
  <div class="card">
    <h1>Payer une commande</h1>
    <form id="paymentForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Num√©ro de carte :
        <input type="text" name="credit_card_number" placeholder="4242 4242 4242 4242" required>
      </label>
      <label>Date d'expiration :
        <input type="text" name="credit_card_expiry_date" placeholder="12/25" required>
      </label>
      <label>CVC :
        <input type="text" name="credit_card_cvv" placeholder="123" required>
      </label>
      <button type="submit" class="btn btn-submit">Payer</button>
    </form>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.origin;
    console.log('üîß Script charg√©, API_BASE:', API_BASE);

    // Fonctions utilitaires
    const calculateShippingPrice = (weightInGrams) => {
      if (weightInGrams <= 500) return 500;       // 5.00 CAD
      if (weightInGrams <= 2000) return 1000;     // 10.00 CAD
      return 2500;                                // 25.00 CAD
    };

    const calculateTaxes = (price, province) => {
      const taxRates = {
        'QC': 0.15, 'ON': 0.13, 'AB': 0.05, 'BC': 0.12, 'NS': 0.14
      };
      const rate = taxRates[province] || 0;
      return Math.round(price * (1 + rate));
    };

    const extractOrderIdFromRedirect = (response) => {
      try {
        const location = response.headers.get('location') || response.url;
        const match = location.match(/\/order\/(\d+)/);
        return match ? parseInt(match[1]) : null;
      } catch {
        return null;
      }
    };

    // Fonction pour afficher une commande
    const getOrder = async (orderId) => {
      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`);
        const data = await res.json();
        
        if (res.ok) {
          const order = data.order || data;
          let status = 'üì¶ En attente';
          if (order.order_status === 'paid') status = '‚úÖ Pay√©e';
          else if (order.order_status === 'payment_processing') status = '‚è≥ Paiement en cours';
          
          alert(`üìä Commande ${orderId} (${status})\nüí∞ Total: ${order.total_price}$\nüöö Livraison: ${order.shipping_price / 100}$\nüßæ Avec taxes: ${order.total_price_tax ? order.total_price_tax + '$' : 'Non calcul√©es'}`);
        } else if (res.status === 202) {
          alert('‚è≥ Commande en cours de traitement (paiement asynchrone)');
        } else {
          alert(`‚ùå Erreur ${res.status}: ${data.message}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // Attendre que le DOM soit charg√©
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM charg√©, attachement des √©v√©nements...');

      // 1. Afficher les produits
      const listProductsBtn = document.getElementById('listProductsBtn');
      if (listProductsBtn) {
        listProductsBtn.onclick = async () => {
          console.log('üîç Clic sur Afficher produits');
          try {
            const res = await fetch(`${API_BASE}/api/products`);
            const data = await res.json();
            const productsOutput = document.getElementById('productsOutput');
            if (productsOutput) {
              productsOutput.textContent = JSON.stringify(data, null, 2);
            }
          } catch (error) {
            console.error('Erreur produits:', error);
            alert(`‚ùå Erreur : ${error.message}`);
          }
        };
      }

      // 2. Ajouter un produit
      const addProductBtn = document.getElementById('addProduct');
      if (addProductBtn) {
        addProductBtn.onclick = () => {
          console.log('‚ûï Ajout d\'un produit');
          const productsList = document.getElementById('productsList');
          const newItem = document.createElement('div');
          newItem.className = 'product-item';
          newItem.innerHTML = `
            <input type="number" name="product_id" placeholder="ID produit" min="1" required>
            <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
            <button type="button" class="btn" style="background: #dc3545; color: white; padding: 0.5rem;" onclick="this.parentElement.remove()">√ó</button>
          `;
          productsList.appendChild(newItem);
        };
      }

      // 3. Cr√©er une commande
      const orderForm = document.getElementById('orderForm');
      if (orderForm) {
        orderForm.onsubmit = async (e) => {
          e.preventDefault();
          console.log('üöÄ Formulaire de commande soumis');
          
          try {
            // R√©cup√©rer les produits
            let allProducts = [];
            try {
              const res = await fetch(`${API_BASE}/api/products`);
              allProducts = await res.json();
              console.log('üì¶ Produits r√©cup√©r√©s:', allProducts.length);
            } catch (error) {
              console.warn('Impossible de r√©cup√©rer les produits:', error);
            }

            // Traiter le formulaire
            const formData = new FormData(e.target);
            const productIds = formData.getAll('product_id');
            const quantities = formData.getAll('quantity');
            
            console.log('üìù Donn√©es formulaire:', { productIds, quantities });

            const products = productIds.map((id, index) => ({
              id: parseInt(id),
              quantity: parseInt(quantities[index])
            })).filter(p => p.id && p.quantity > 0);
            
            console.log('üîç Produits trait√©s:', products);

            if (products.length === 0) {
              alert('‚ùå Veuillez ajouter au moins un produit.');
              return;
            }

            // Calculs estimatifs
            let estimatedPrice = 0;
            let estimatedWeight = 0;
            products.forEach(product => {
              const productInfo = allProducts.products?.find(p => p.id === product.id);
              if (productInfo) {
                estimatedPrice += productInfo.price * product.quantity;
                estimatedWeight += productInfo.weight * product.quantity;
              }
            });

            const estimatedShipping = calculateShippingPrice(estimatedWeight);
            console.log('üí° Estimation:', { estimatedPrice, estimatedWeight, estimatedShipping });

            // Appel API
            const payload = { products };
            console.log('üöÄ Appel API avec:', payload);

            const res = await fetch(`${API_BASE}/order`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              redirect: 'manual'
            });

            console.log('üì° R√©ponse API:', res.status, res.statusText);

            if (res.status === 0 || res.status === 302) {
              const orderId = extractOrderIdFromRedirect(res);
              alert(`‚úÖ Commande cr√©√©e ! ID: ${orderId || 'Inconnue'}\n\nüí° Estimation: ${estimatedPrice / 100}$ + livraison ${estimatedShipping / 100}$ = ${(estimatedPrice + estimatedShipping) / 100}$`);
              if (orderId) {
                setTimeout(() => getOrder(orderId), 500);
              }
            } else {
              const text = await res.text();
              let data;
              try {
                data = JSON.parse(text);
              } catch {
                data = { message: text };
              }
              alert(`‚ùå Erreur ${res.status}: ${data.message || text}`);
            }
          } catch (error) {
            console.error('Erreur cr√©ation commande:', error);
            alert(`‚ùå Erreur : ${error.message}`);
          }
        };
      }

      // 4. Afficher une commande
      const getOrderForm = document.getElementById('getOrderForm');
      if (getOrderForm) {
        getOrderForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          await getOrder(orderId);
        };
      }

      // 5. Ajouter une adresse
      const shippingForm = document.getElementById('shippingForm');
      if (shippingForm) {
        shippingForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          
          const payload = {
            shipping_information: {
              address: formData.get('address'),
              city: formData.get('city'),
              province: formData.get('province'),
              postal_code: formData.get('postal_code'),
              country: formData.get('country')
            }
          };

          try {
            const res = await fetch(`${API_BASE}/order/${orderId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              data = { message: text };
            }

            if (res.ok) {
              const province = formData.get('province');
              const taxRate = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' }[province] || '0%';
              alert(`‚úÖ Adresse ajout√©e !\nüè† Province: ${province} (Taxe ${taxRate})\nüí° Les taxes ont √©t√© recalcul√©es automatiquement.`);
              setTimeout(() => getOrder(orderId), 500);
            } else {
              if (res.status === 409) {
                alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
              } else {
                const err = data.errors?.shipping_information || {};
                alert(`‚ùå Erreur adresse : ${err.province || err.address || data.message || text}`);
              }
            }
          } catch (error) {
            alert(`‚ùå Erreur : ${error.message}`);
          }
        };
      }

      // 6. Payer une commande
      const paymentForm = document.getElementById('paymentForm');
      if (paymentForm) {
        paymentForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          
          const payload = {
            credit_card: {
              credit_card_number: formData.get('credit_card_number'),
              credit_card_expiry_date: formData.get('credit_card_expiry_date'),
              credit_card_cvv: formData.get('credit_card_cvv')
            }
          };

          try {
            const res = await fetch(`${API_BASE}/order/${orderId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              data = { message: text };
            }

            if (res.ok) {
              alert('‚úÖ Paiement effectu√© avec succ√®s !');
              setTimeout(() => getOrder(orderId), 500);
            } else if (res.status === 202) {
              alert('‚è≥ Paiement en cours de traitement...\nüí° Statut: 202 Accepted (traitement asynchrone)\nüîÑ Consultez la commande dans quelques secondes.');
            } else {
              if (res.status === 409) {
                alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
              } else {
                const err = data.errors?.order || {};
                alert(`‚ùå Erreur paiement : ${err.name || data.message || text}`);
              }
            }
          } catch (error) {
            alert(`‚ùå Erreur : ${error.message}`);
          }
        };
      }

      console.log('‚úÖ Tous les √©v√©nements attach√©s');
    });
  </script>
</body>
</html>
