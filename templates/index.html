<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes – Test API</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; line-height: 1.6; margin: 2rem; background: #f5f7fa; }
    .card { background: white; padding: 2rem; margin: 2rem 0; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .btn { padding: 0.75rem 1.5rem; margin: 0.5rem 0.25rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
    .btn-blue { background: #3498db; color: white; }
    .btn-green { background: #27ae60; color: white; }
    .btn-submit { background: #27ae60; color: white; }
    .btn-add { background: #9b59b6; color: white; }
    .btn:hover { opacity: 0.9; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    label { display: flex; flex-direction: column; gap: 0.5rem; font-weight: 500; }
    input, select { padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; }
    input:focus, select:focus { outline: none; border-color: #3498db; }
    pre { background: #2c3e50; color: #ecf0f1; padding: 1.5rem; border-radius: 6px; overflow-x: auto; max-height: 400px; }
    .inline { flex-direction: row; align-items: end; gap: 1rem; }
    .products-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .product-item { display: flex; gap: 0.5rem; align-items: center; }
    .product-item input { flex: 1; }
  </style>
</head>
<body>
  <h1>Interface de Test – API de Gestion de Commandes</h1>

  <!-- Liste des produits -->
  <div class="card">
    <h1>Liste des produits</h1>
    <button id="listProductsBtn" class="btn btn-blue">Afficher produits</button>
    <pre id="productsOutput"></pre>
  </div>

  <!-- Créer une commande -->
  <div class="card">
    <h1>Créer une commande</h1>
    <form id="orderForm">
      <div class="products-list" id="productsList">
        <div class="product-item">
          <input type="number" name="product_id" placeholder="ID produit" min="1" required>
          <input type="number" name="quantity"   placeholder="Quantité"  min="1" value="1" required>
        </div>
      </div>
      <button type="button" class="btn btn-add"    id="addProduct">+ Ajouter un produit</button>
      <button type="submit" class="btn btn-submit">Créer</button>
    </form>
  </div>

  <!-- Afficher une commande -->
  <div class="card">
    <h1>Afficher une commande</h1>
    <form id="getOrderForm" class="inline">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <button type="submit" class="btn btn-blue">Afficher</button>
    </form>
  </div>

  <!-- Ajouter une adresse -->
  <div class="card">
    <h1>Ajouter une adresse de livraison</h1>
    <form id="shippingForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Adresse :
        <input type="text" name="address" placeholder="123 rue de la Paix" required>
      </label>
      <label>Ville :
        <input type="text" name="city" placeholder="Montréal" required>
      </label>
      <label>Province :
        <select name="province" required>
          <option value="">Sélectionnez…</option>
          <option value="QC">QC - Québec (15%)</option>
          <option value="ON">ON - Ontario (13%)</option>
          <option value="AB">AB - Alberta (5%)</option>
          <option value="BC">BC - Colombie-Britannique (12%)</option>
          <option value="NS">NS - Nouvelle-Écosse (14%)</option>
          <option value="NB">NB - Nouveau-Brunswick (0%)</option>
          <option value="PE">PE - Île-du-Prince-Édouard (0%)</option>
          <option value="SK">SK - Saskatchewan (0%)</option>
          <option value="MB">MB - Manitoba (0%)</option>
          <option value="NL">NL - Terre-Neuve-et-Labrador (0%)</option>
          <option value="NT">NT - Territoires du Nord-Ouest (0%)</option>
          <option value="NU">NU - Nunavut (0%)</option>
          <option value="YT">YT - Yukon (0%)</option>
        </select>
      </label>
      <label>Code postal :
        <input type="text" name="postal_code" placeholder="H2X 3Y4" required>
      </label>
      <label>Pays :
        <input type="text" name="country" value="Canada" required>
      </label>
      
      <!-- Affichage automatique des taxes -->
      <div class="tax-display" id="taxDisplay" style="display: none;">
        <strong>Taux de taxe calculé :</strong>
        <span class="tax-percentage" id="taxPercent">0%</span>
        <br>
        <small>Les taxes seront appliquées automatiquement lors de l'ajout de l'adresse</small>
      </div>
      
      <button type="submit" class="btn btn-submit" id="addShippingBtn">Ajouter adresse</button>
    </form>
  </div>

  <!-- Payer une commande -->
  <div class="card">
    <h1>Payer une commande</h1>
    <form id="paymentForm" class="payment-form">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      
      <label>Nom sur la carte :
        <div class="card-input-group">
          <input type="text" 
                 name="cardholder_name" 
                 placeholder="Ex: Jean Dupont"
                 minlength="2"
                 maxlength="50"
                 pattern="[A-Za-zÀ-ÿ\s-]+"
                 autocomplete="cc-name"
                 required>
          <span class="field-error">Le nom doit contenir uniquement des lettres</span>
        </div>
      </label>
      
      <label>Numéro de carte :
        <div class="card-input-group">
          <input type="text" 
                 name="credit_card_number" 
                 placeholder="1234 5678 9012 3456"
                 maxlength="19"
                 pattern="[0-9\s]{13,19}"
                 inputmode="numeric"
                 autocomplete="cc-number"
                 required>
          <span class="field-error">Le numéro de carte doit contenir 13-16 chiffres</span>
        </div>
      </label>
      
      <div class="card-row">
        <label>Date d'expiration :
          <div class="card-input-group">
            <input type="text" 
                   name="credit_card_expiry_date" 
                   placeholder="MM/AA"
                   maxlength="5"
                   pattern="(0[1-9]|1[0-2])\/([0-9]{2})"
                   inputmode="numeric"
                   autocomplete="cc-exp"
                   required>
            <span class="field-error">Format: MM/AA</span>
          </div>
        </label>
        
        <label>CVV :
          <div class="card-input-group">
            <input type="text" 
                   name="credit_card_cvv" 
                   placeholder="123"
                   maxlength="3"
                   pattern="[0-9]{3}"
                   inputmode="numeric"
                   autocomplete="cc-csc"
                   required>
            <span class="field-error">3 chiffres requis</span>
          </div>
        </label>
      </div>
      
      <button type="submit" class="btn btn-submit">Payer</button>
    </form>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.origin;
    console.log('Script chargé, API_BASE:', API_BASE);

    // Fonctions utilitaires
    const calculateShippingPrice = (weightInGrams) => {
      if (weightInGrams <= 500) return 500;       // 5.00 CAD
      if (weightInGrams <= 2000) return 1000;     // 10.00 CAD
      return 2500;                                // 25.00 CAD
    };

    const calculateTaxes = (price, province) => {
      const taxRates = {
        'QC': 0.15, 'ON': 0.13, 'AB': 0.05, 'BC': 0.12, 'NS': 0.14
      };
      const rate = taxRates[province] || 0;
      return Math.round(price * (1 + rate));
    };

    const extractOrderIdFromRedirect = (response) => {
      try {
        const location = response.headers.get('location') || response.url;
        const match = location.match(/\/order\/(\d+)/);
        return match ? parseInt(match[1]) : null;
      } catch {
        return null;
      }
    };

    // Fonction pour afficher une commande
    const getOrder = async (orderId) => {
      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`);
        const data = await res.json();
        
        if (res.ok) {
          const order = data.order || data;
          
          // Déterminer le statut avec icônes plus claires
          let status = '❌ Non payée';
          if (order.order_status === 'paid') {
            status = '✅ Payée';
          } else if (order.order_status === 'payment_processing') {
            status = '⏳ Paiement en cours...';
          }
          
          // Affichage détaillé avec statut de paiement en évidence
          let message = `Commande ${orderId}\n`;
          message += `Statut: ${status}\n`;
          message += `\nDétails financiers:\n`;
          message += `   • Sous-total: ${order.total_price}$\n`;
          message += `   • Livraison: ${order.shipping_price / 100}$\n`;
          
          if (order.shipping_information && order.shipping_information.province) {
            const province = order.shipping_information.province;
            const taxRates = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' };
            const taxRate = taxRates[province] || '0%';
            message += `   • Province: ${province} (Taxe ${taxRate})\n`;
          }
          
          if (order.total_price_tax && order.total_price_tax > 0) {
            message += `   • Total avec taxes: ${order.total_price_tax}$\n`;
            message += `\nTotal final: ${(order.total_price_tax + order.shipping_price / 100).toFixed(2)}$ CAD`;
          } else {
            message += `\nTaxes: Non calculées (ajoutez une adresse)`;
          }
          
          alert(message);
        } else if (res.status === 202) {
          alert('⏳ Commande en cours de traitement (paiement asynchrone)');
        } else {
          alert(`❌ Erreur ${res.status}: ${data.message}`);
        }
      } catch (error) {
        alert(`❌ Erreur : ${error.message}`);
      }
    };

    // Attendre que le DOM soit chargé
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM chargé, attachement des événements...');
      
      // ===== NOUVEAU: Formatage automatique des champs de carte bancaire =====
      
      // Formatage du numéro de carte (groupes de 4 chiffres)
      const cardNumberInput = document.querySelector('input[name="credit_card_number"]');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
          value = value.substring(0, 16); // Max 16 chiffres
          value = value.replace(/(\d{4})(?=\d)/g, '$1 '); // Grouper par 4
          e.target.value = value;
        });
      }
      
      // Formatage de la date d'expiration (MM/AA)
      const expiryInput = document.querySelector('input[name="credit_card_expiry_date"]');
      if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }
      
      // Formatage du CVV (3 chiffres max)
      const cvvInput = document.querySelector('input[name="credit_card_cvv"]');
      if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
          value = value.substring(0, 3); // Max 3 chiffres
          e.target.value = value;
        });
      }
      
      // ===== NOUVEAU: Calcul automatique des taxes =====
      
      // Fonction pour calculer et afficher les taxes
      function calculateAndDisplayTax() {
        const provinceSelect = document.querySelector('select[name="province"]');
        const taxDisplay = document.getElementById('taxDisplay');
        const taxPercent = document.getElementById('taxPercent');
        
        if (provinceSelect && taxDisplay && taxPercent) {
          const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
          if (selectedOption && selectedOption.value) {
            // Extraire le pourcentage de taxe du texte de l'option
            const match = selectedOption.textContent.match(/\((\d+)%\)/);
            const taxRate = match ? match[1] + '%' : '0%';
            
            taxPercent.textContent = taxRate;
            taxDisplay.style.display = 'block';
            taxDisplay.classList.add('updated');
            
            // Retirer l'animation après 500ms
            setTimeout(() => {
              taxDisplay.classList.remove('updated');
            }, 500);
          } else {
            taxDisplay.style.display = 'none';
          }
        }
      }
      
      // Écouter les changements de province
      const provinceSelect = document.querySelector('select[name="province"]');
      if (provinceSelect) {
        provinceSelect.addEventListener('change', calculateAndDisplayTax);
      }
      
      // =====
      
      // Test immédiat des éléments critiques
      setTimeout(() => {
        const orderForm = document.getElementById('orderForm');
        const submitBtn = orderForm?.querySelector('button[type="submit"]');
        console.log('Test éléments:');
        console.log('  - orderForm:', !!orderForm);
        console.log('  - submitBtn:', !!submitBtn);
        console.log('  - API_BASE:', API_BASE);
      }, 100);

      // 1. Afficher les produits
      const listProductsBtn = document.getElementById('listProductsBtn');
      if (listProductsBtn) {
        listProductsBtn.onclick = async () => {
          console.log('Clic sur Afficher produits');
          try {
            const res = await fetch(`${API_BASE}/api/products`);
            const data = await res.json();
            const productsOutput = document.getElementById('productsOutput');
            if (productsOutput) {
              productsOutput.textContent = JSON.stringify(data, null, 2);
            }
          } catch (error) {
            console.error('Erreur produits:', error);
            alert(`❌ Erreur : ${error.message}`);
          }
        };
      }

      // 2. Ajouter un produit
      const addProductBtn = document.getElementById('addProduct');
      if (addProductBtn) {
        addProductBtn.onclick = () => {
          console.log('Ajout d\'un produit');
          const productsList = document.getElementById('productsList');
          const newItem = document.createElement('div');
          newItem.className = 'product-item';
          newItem.innerHTML = `
            <input type="number" name="product_id" placeholder="ID produit" min="1" required>
            <input type="number" name="quantity"   placeholder="Quantité"  min="1" value="1" required>
            <button type="button" class="btn" style="background: #dc3545; color: white; padding: 0.5rem;" onclick="this.parentElement.remove()">×</button>
          `;
          productsList.appendChild(newItem);
        };
      }

      // 3. Créer une commande
      const orderForm = document.getElementById('orderForm');
      if (orderForm) {
        console.log('Formulaire orderForm trouvé');
        orderForm.onsubmit = async (e) => {
          e.preventDefault();
          console.log('DÉBUT - Formulaire soumis');
          
          // Version ultra-simplifiée pour tester
          try {
            // Récupérer les données du formulaire
            const formData = new FormData(e.target);
            const productIds = formData.getAll('product_id');
            const quantities = formData.getAll('quantity');
            
            console.log('Données brutes:', { productIds, quantities });

            // Créer le payload
            const products = productIds.map((id, index) => ({
              id: parseInt(id),
              quantity: parseInt(quantities[index])
            })).filter(p => p.id && p.quantity > 0);
            
            console.log('Produits traités:', products);

            if (products.length === 0) {
              alert('❌ Veuillez ajouter au moins un produit.');
              return;
            }

            const payload = { products };
            console.log('� Payload à envoyer:', JSON.stringify(payload));

            // Appel API simplifié
            console.log('� Envoi vers:', `${API_BASE}/order`);
            const res = await fetch(`${API_BASE}/order`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            console.log('📡 Réponse reçue:', res.status, res.statusText);

            if (res.redirected || res.status === 302) {
              console.log('✅ Redirection détectée, commande créée');
              const locationUrl = res.url;
              const orderIdMatch = locationUrl.match(/\/order\/(\d+)/);
              const orderId = orderIdMatch ? orderIdMatch[1] : 'Inconnue';
              
              alert(`Commande créée avec succès !\nID: ${orderId}`);
              
              // Optionnel: afficher la commande créée
              if (orderId !== 'Inconnue') {
                setTimeout(() => getOrder(parseInt(orderId)), 1000);
              }
            } else if (res.ok) {
              const data = await res.json();
              console.log('Réponse OK:', data);
              alert('Commande créée avec succès !');
            } else {
              const text = await res.text();
              console.error('❌ Erreur:', res.status, text);
              alert(`❌ Erreur ${res.status}: ${text}`);
            }
          } catch (error) {
            console.error('❌ Exception:', error);
            alert(`❌ Erreur : ${error.message}`);
          }
        };
      } else {
        console.error('❌ Formulaire orderForm NON TROUVÉ !');
      }

      // 4. Afficher une commande
      const getOrderForm = document.getElementById('getOrderForm');
      if (getOrderForm) {
        getOrderForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          await getOrder(orderId);
        };
      }

      // 5. Ajouter une adresse
      const shippingForm = document.getElementById('shippingForm');
      if (shippingForm) {
        shippingForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          
          const payload = {
            shipping_information: {
              address: formData.get('address'),
              city: formData.get('city'),
              province: formData.get('province'),
              postal_code: formData.get('postal_code'),
              country: formData.get('country')
            }
          };

          try {
            const res = await fetch(`${API_BASE}/order/${orderId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              data = { message: text };
            }

            if (res.ok) {
              const province = formData.get('province');
              const taxRate = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' }[province] || '0%';
              alert(`✅ Adresse ajoutée !\nProvince: ${province} (Taxe ${taxRate})\nLes taxes ont été recalculées automatiquement.`);
              setTimeout(() => getOrder(orderId), 500);
            } else {
              if (res.status === 409) {
                alert('❌ Impossible de modifier une commande déjà payée.');
              } else {
                const err = data.errors?.shipping_information || {};
                alert(`❌ Erreur adresse : ${err.province || err.address || data.message || text}`);
              }
            }
          } catch (error) {
            alert(`❌ Erreur : ${error.message}`);
          }
        };
      }

      // 6. Payer une commande
      const paymentForm = document.getElementById('paymentForm');
      if (paymentForm) {
        paymentForm.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const orderId = parseInt(formData.get('order_id'));
          
          // Parsing de la date d'expiration MM/AA
          const expiryDate = formData.get('credit_card_expiry_date');
          const expiryParts = expiryDate.split('/');
          const expiryMonth = parseInt(expiryParts[0]);
          const expiryYear = parseInt('20' + expiryParts[1]);
          
          const payload = {
            credit_card: {
              name: formData.get('cardholder_name'),
              number: formData.get('credit_card_number').replace(/\s/g, ''),
              expiration_month: expiryMonth,
              expiration_year: expiryYear,
              cvv: formData.get('credit_card_cvv')
            }
          };

          // Validation des données
          if (!payload.credit_card.name || payload.credit_card.name.trim().length < 2) {
            alert('❌ Le nom sur la carte est requis');
            return;
          }
          if (!payload.credit_card.number || payload.credit_card.number.length < 13) {
            alert('❌ Numéro de carte invalide');
            return;
          }
          if (isNaN(expiryMonth) || isNaN(expiryYear) || expiryMonth < 1 || expiryMonth > 12) {
            alert('❌ Date d\'expiration invalide (format MM/AA)');
            return;
          }

          try {
            const res = await fetch(`${API_BASE}/order/${orderId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              data = { message: text };
            }

            if (res.ok) {
              alert('✅ Paiement effectué avec succès !');
              setTimeout(() => getOrder(orderId), 500);
            } else if (res.status === 202) {
              alert('⏳ Paiement en cours de traitement...\nStatut: 202 Accepted (traitement asynchrone)\nVérification automatique du statut...');
              
              // Vérifier le statut toutes les 2 secondes pendant 30 secondes max
              const checkPaymentStatus = async (attempts = 0) => {
                if (attempts >= 15) { // 15 x 2 sec = 30 sec max
                  alert('⏰ Délai d\'attente dépassé. Veuillez vérifier manuellement le statut de la commande.');
                  return;
                }
                
                try {
                  const statusRes = await fetch(`${API_BASE}/order/${orderId}`);
                  if (statusRes.status === 202) {
                    // Encore en traitement, réessayer dans 2 secondes
                    setTimeout(() => checkPaymentStatus(attempts + 1), 2000);
                  } else {
                    // Traitement terminé, afficher le résultat
                    setTimeout(() => {
                      alert('Paiement terminé ! Voici le statut final :');
                      getOrder(orderId);
                    }, 500);
                  }
                } catch (error) {
                  console.error('Erreur lors de la vérification du statut:', error);
                  setTimeout(() => checkPaymentStatus(attempts + 1), 2000);
                }
              };
              
              // Commencer la vérification après 2 secondes
              setTimeout(() => checkPaymentStatus(), 2000);
            } else {
              if (res.status === 409) {
                alert('❌ Impossible de modifier une commande déjà payée.');
              } else {
                const err = data.errors?.order || {};
                alert(`❌ Erreur paiement : ${err.name || data.message || text}`);
              }
            }
          } catch (error) {
            alert(`❌ Erreur : ${error.message}`);
          }
        };
      }

      console.log('Tous les événements attachés');
    });
  </script>
</body>
</html>
