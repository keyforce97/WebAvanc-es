<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes ‚Äì Test API</title>
  <style>
    /* Reset & typo */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: "Segoe UI", sans-serif; background: #f0f4f8; color: #333; padding: 2rem; }
    h1 { margin-bottom: 0.5rem; color: #005f99; }

    /* Card container */
    .card { background: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; }

    /* Form layout */
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; font-weight: 600; }
    input, select, textarea { padding: 0.5rem; border: 1px solid #ccc; border-radius: .5rem; font-size: 1rem; }
    .products-list { display: grid; gap: .5rem; margin-top: .5rem; }
    .product-item { display: flex; gap: .5rem; }
    .product-item input { flex: 1; }

    /* Buttons */
    .btn { padding: .75rem 1.5rem; border: none; border-radius: 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .btn-add    { background: #007acc; color: #fff; width: fit-content; }
    .btn-submit { background: #28a745; color: #fff; }
    .btn-blue   { background: #007bff; color: white; }

    /* Inline small form */
    .inline { display: flex; gap: .5rem; align-items: center; }
    .inline input { width: 4rem; }

    /* Output JSON */
    pre#productsOutput {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: .5rem;
      max-height: 300px;
      overflow: auto;
      margin-top: 1rem;
      font-family: monospace;
      font-size: .9rem;
    }

    /* Rules section */
    .rules { background: #e8f4fd; border-left: 4px solid #007acc; padding: 1rem; margin: 1rem 0; }
    .rules h3 { color: #005f99; margin-bottom: 0.5rem; }
    .rules ul { margin-left: 1rem; }
    .rules li { margin: 0.25rem 0; }
    .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
    .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
  </style>
</head>
<body>

  <!-- Liste des produits (maintenant en haut) -->
  <div class="card">
    <h1>üì¶ Liste des produits</h1>
    <div class="inline">
      <button id="listProductsBtn" class="btn btn-blue">Afficher produits</button>
    </div>
    <pre id="productsOutput"></pre>
  </div>

  <!-- Cr√©er une commande -->
  <div class="card">
    <h1>Cr√©er une commande</h1>
    <form id="orderForm">
      <div class="products-list" id="productsList">
        <div class="product-item">
          <input type="number" name="product_id" placeholder="ID produit" min="1" required>
          <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
        </div>
      </div>
      <button type="button" class="btn btn-add"    id="addProduct">+ Ajouter un produit</button>
      <button type="submit" class="btn btn-submit">Cr√©er</button>
    </form>
  </div>

  <!-- Afficher une commande -->
  <div class="card">
    <h1>Afficher une commande</h1>
    <form id="getOrderForm" class="inline">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <button type="submit" class="btn btn-blue">Afficher</button>
    </form>
  </div>

  <!-- Ajouter une adresse -->
  <div class="card">
    <h1>Ajouter une adresse (taxes)</h1>
    <div class="rules warning">
      <h4>‚ö†Ô∏è Rappel :</h4>
      <ul>
        <li><strong>Taxes par province :</strong> QC=15%, ON=13%, AB=5%, BC=12%, NS=14%, autres=0%</li>
        <li><strong>Important :</strong> Les taxes s'appliquent seulement sur le prix des produits, pas sur les frais de livraison</li>
      </ul>
    </div>
    <form id="shippingForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Adresse :
        <input type="text" name="address" placeholder="123 rue de la Paix" required>
      </label>
      <label>Ville :
        <input type="text" name="city" placeholder="Montr√©al" required>
      </label>
      <label>Province :
        <select name="province" required>
          <option value="">S√©lectionnez‚Ä¶</option>
          <option value="QC">QC - Qu√©bec (15%)</option>
          <option value="ON">ON - Ontario (13%)</option>
          <option value="AB">AB - Alberta (5%)</option>
          <option value="BC">BC - Colombie-Britannique (12%)</option>
          <option value="NS">NS - Nouvelle-√âcosse (14%)</option>
          <option value="NB">NB - Nouveau-Brunswick (0%)</option>
          <option value="PE">PE - √éle-du-Prince-√âdouard (0%)</option>
          <option value="SK">SK - Saskatchewan (0%)</option>
          <option value="MB">MB - Manitoba (0%)</option>
          <option value="NL">NL - Terre-Neuve-et-Labrador (0%)</option>
          <option value="NT">NT - Territoires du Nord-Ouest (0%)</option>
          <option value="NU">NU - Nunavut (0%)</option>
          <option value="YT">YT - Yukon (0%)</option>
        </select>
      </label>
      <label>Code postal :
        <input type="text" name="postal_code" placeholder="H2X 3Y4" required>
      </label>
      <label>Pays :
        <input type="text" name="country" value="Canada" required>
      </label>
      <button type="submit" class="btn btn-submit">Ajouter adresse</button>
    </form>
  </div>

  <!-- Payer une commande -->
  <div class="card">
    <h1>Payer une commande</h1>
    <form id="paymentForm">
      <label>ID commande :
        <input type="number" name="order_id" min="1" placeholder="Ex : 1" required>
      </label>
      <label>Num√©ro de carte :
        <input type="text" name="credit_card_number" placeholder="4242 4242 4242 4242" required>
      </label>
      <label>Date d'expiration :
        <input type="text" name="credit_card_expiry_date" placeholder="12/25" required>
      </label>
      <label>CVC :
        <input type="text" name="credit_card_cvv" placeholder="123" required>
      </label>
      <button type="submit" class="btn btn-submit">Payer</button>
    </form>
  </div>

  <script>
    // URL de base de l'API
    const API_BASE = window.location.origin;
    
    // Test de diagnostic
    console.log('üîß Script charg√©, API_BASE:', API_BASE);
    
    // V√©rifier que tous les √©l√©ments existent
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM charg√©');
      const orderForm = document.getElementById('orderForm');
      const listBtn = document.getElementById('listProductsBtn');
      const addBtn = document.getElementById('addProduct');
      
      console.log('üîç √âl√©ments trouv√©s:');
      console.log('  - orderForm:', !!orderForm);
      console.log('  - listProductsBtn:', !!listBtn);
      console.log('  - addProduct:', !!addBtn);
      
      if (!orderForm) {
        console.error('‚ùå Formulaire orderForm introuvable !');
        return;
      }
    });

    // 2) Fonction utilitaire pour calculer les frais de livraison
    const calculateShippingPrice = (weightInGrams) => {
      if (weightInGrams <= 500) return 500;       // 5.00 CAD
      if (weightInGrams <= 2000) return 1000;     // 10.00 CAD
      return 2500;                                // 25.00 CAD
    };

    // 3) Fonction utilitaire pour calculer les taxes
    const calculateTaxes = (price, province) => {
      const taxRates = {
        'QC': 0.15, 'ON': 0.13, 'AB': 0.05, 'BC': 0.12, 'NS': 0.14
      };
      const rate = taxRates[province] || 0;
      return Math.round(price * (1 + rate));
    };

    // Fonction utilitaire pour extraire l'ID de commande depuis la redirection
    const extractOrderIdFromRedirect = (response) => {
      try {
        const location = response.headers.get('location') || response.url;
        const match = location.match(/\/order\/(\d+)/);
        return match ? parseInt(match[1]) : null;
      } catch {
        return null;
      }
    };

    // Attendre que le DOM soit charg√© avant d'attacher les √©v√©nements
    document.addEventListener('DOMContentLoaded', function() {
    
    // 4) Ajouter un produit dans le formulaire
    const addProductBtn = document.getElementById('addProduct');
    if (addProductBtn) {
      addProductBtn.onclick = () => {
      const productsList = document.getElementById('productsList');
      const newItem = document.createElement('div');
      newItem.className = 'product-item';
      newItem.innerHTML = `
        <input type="number" name="product_id" placeholder="ID produit" min="1" required>
        <input type="number" name="quantity"   placeholder="Quantit√©"  min="1" value="1" required>
        <button type="button" class="btn" style="background: #dc3545; color: white; padding: 0.5rem;" onclick="this.parentElement.remove()">√ó</button>
      `;
      productsList.appendChild(newItem);
      };
    }

    // 5) Cr√©er une commande
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
      orderForm.onsubmit = async (e) => {
      e.preventDefault();
      console.log('üöÄ Formulaire soumis - d√©but du processus');
      
      // R√©cup√©rer la liste des produits pour enrichir les infos
      let allProducts = [];
      try {
        const res = await fetch(`${API_BASE}/api/products`);
        allProducts = await res.json();
        console.log('üì¶ Produits r√©cup√©r√©s:', allProducts.length);
      } catch (error) {
        console.warn('Impossible de r√©cup√©rer la liste des produits:', error);
        alert('‚ö†Ô∏è Impossible de r√©cup√©rer la liste des produits: ' + error.message);
      }

      const formData = new FormData(e.target);
      const productIds = formData.getAll('product_id');
      const quantities = formData.getAll('quantity');
      
      console.log('üìù Donn√©es formulaire:');
      console.log('  - Product IDs:', productIds);
      console.log('  - Quantities:', quantities);

      const products = productIds.map((id, index) => ({
        id: parseInt(id),
        quantity: parseInt(quantities[index])
      })).filter(p => p.id && p.quantity > 0);
      
      console.log('üîç Produits trait√©s:', products);

      if (products.length === 0) {
        alert('‚ùå Veuillez ajouter au moins un produit.');
        console.log('‚ùå Aucun produit valide trouv√©');
        return;
      }

      // Calcul estimatif c√¥t√© frontend
      let estimatedPrice = 0;
      let estimatedWeight = 0;
      let productDetails = [];

      products.forEach(product => {
        const productInfo = allProducts.find(p => p.id === product.id);
        if (productInfo) {
          const itemPrice = productInfo.price * product.quantity;
          const itemWeight = productInfo.weight * product.quantity;
          estimatedPrice += itemPrice;
          estimatedWeight += itemWeight;
          productDetails.push({
            ...productInfo,
            quantity: product.quantity,
            totalPrice: itemPrice,
            totalWeight: itemWeight
          });
        }
      });

      const estimatedShipping = calculateShippingPrice(estimatedWeight);

      console.log('üí° Estimation c√¥t√© frontend:');
      console.log(`‚Ä¢ Prix total: ${estimatedPrice / 100}$`);
      console.log(`‚Ä¢ Poids total: ${estimatedWeight}g`);
      console.log(`‚Ä¢ Frais livraison: ${estimatedShipping / 100}$`);
      console.log('‚Ä¢ D√©tails:', productDetails);

      const payload = { products };
      console.log('üöÄ Appel API avec payload:', payload);

      try {
        const res = await fetch(`${API_BASE}/order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          redirect: 'manual'
        });
        
        console.log('üì° R√©ponse API:', res.status, res.statusText);

        if (res.status === 0 || res.status === 302) {
          // Redirection 302 d√©tect√©e ‚Üí succ√®s
          const orderId = extractOrderIdFromRedirect(res);
          alert(`‚úÖ Commande cr√©√©e ! ID: ${orderId || 'Inconnue'}\n\nüí° Estimation: ${estimatedPrice / 100}$ + livraison ${estimatedShipping / 100}$ = ${(estimatedPrice + estimatedShipping) / 100}$`);
          // R√©cup√©rer automatiquement la commande cr√©√©e
          if (orderId) {
            setTimeout(() => getOrder(orderId), 500);
          }
        } else {
          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { message: text };
          }
          alert(`‚ùå Erreur ${res.status}: ${data.message || text}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    // Fonction utilitaire pour extraire l'ID de commande depuis la redirection
    const extractOrderIdFromRedirect = (response) => {
      try {
        const location = response.headers.get('location') || response.url;
        const match = location.match(/\/order\/(\d+)/);
        return match ? parseInt(match[1]) : null;
      } catch {
        return null;
      }
    };

    // 1) Afficher la liste des produits
    const listProductsBtn = document.getElementById('listProductsBtn');
    if (listProductsBtn) {
      listProductsBtn.onclick = async () => {
        try {
          const res = await fetch(`${API_BASE}/api/products`);
          const data = await res.json();
          const productsOutput = document.getElementById('productsOutput');
          if (productsOutput) {
            productsOutput.textContent = JSON.stringify(data, null, 2);
          }
        } catch (error) {
          alert(`‚ùå Erreur : ${error.message}`);
        }
      };
    }

    // 6) Afficher une commande
    const getOrder = async (orderId) => {
      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`);
        const data = await res.json();
        
        if (res.ok) {
          const order = data.order || data;
          let status = 'üì¶ En attente';
          if (order.order_status === 'paid') status = '‚úÖ Pay√©e';
          else if (order.order_status === 'payment_processing') status = '‚è≥ Paiement en cours';
          
          alert(`üìä Commande ${orderId} (${status})\nüí∞ Total: ${order.total_price}$\nüöö Livraison: ${order.shipping_price / 100}$\nüßæ Avec taxes: ${order.total_price_tax ? order.total_price_tax + '$' : 'Non calcul√©es'}`);
        } else if (res.status === 202) {
          alert('‚è≥ Commande en cours de traitement (paiement asynchrone)');
        } else {
          alert(`‚ùå Erreur ${res.status}: ${data.message}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
      }
    };

    const getOrderForm = document.getElementById('getOrderForm');
    if (getOrderForm) {
      getOrderForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      await getOrder(orderId);
      };
    }

    // 7) Ajouter une adresse
    const shippingForm = document.getElementById('shippingForm');
    if (shippingForm) {
      shippingForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      
      const payload = {
        shipping_information: {
          address: formData.get('address'),
          city: formData.get('city'),
          province: formData.get('province'),
          postal_code: formData.get('postal_code'),
          country: formData.get('country')
        }
      };

      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { message: text };
        }

        if (res.ok) {
          const province = formData.get('province');
          const taxRate = { 'QC': '15%', 'ON': '13%', 'AB': '5%', 'BC': '12%', 'NS': '14%' }[province] || '0%';
          alert(`‚úÖ Adresse ajout√©e !\nüè† Province: ${province} (Taxe ${taxRate})\nüí° Les taxes ont √©t√© recalcul√©es automatiquement.`);
          
          // Afficher automatiquement la commande mise √† jour
          setTimeout(() => getOrder(orderId), 500);
        } else {
          if (res.status === 409) {
            alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
          } else {
            const err = data.errors?.shipping_information || {};
            alert(`‚ùå Erreur adresse : ${err.province || err.address || data.message || text}`);
          }
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
        }
      }
    };

    // 9) Payer une commande
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
      paymentForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const orderId = parseInt(formData.get('order_id'));
      
      const payload = {
        credit_card: {
          credit_card_number: formData.get('credit_card_number'),
          credit_card_expiry_date: formData.get('credit_card_expiry_date'),
          credit_card_cvv: formData.get('credit_card_cvv')
        }
      };

      try {
        const res = await fetch(`${API_BASE}/order/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { message: text };
        }

        if (res.ok) {
          alert('‚úÖ Paiement effectu√© avec succ√®s !');
          // Afficher la commande pay√©e
          setTimeout(() => getOrder(orderId), 500);
        } else if (res.status === 202) {
          alert('‚è≥ Paiement en cours de traitement...\nüí° Statut: 202 Accepted (traitement asynchrone)\nüîÑ Consultez la commande dans quelques secondes.');
        } else {
          if (res.status === 409) {
            alert('‚ùå Impossible de modifier une commande d√©j√† pay√©e.');
          } else {
            const err = data.errors?.order || {};
            alert(`‚ùå Erreur paiement : ${err.name || data.message || text}`);
          }
        }
      } catch (error) {
        alert(`‚ùå Erreur : ${error.message}`);
        }
      };
    }
    
    }); // Fin du DOMContentLoaded
  </script>
</body>
</html>
